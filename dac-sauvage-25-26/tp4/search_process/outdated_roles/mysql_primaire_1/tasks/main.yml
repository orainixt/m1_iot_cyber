# - name: Get primary binlog file name and binlog position from db2 
#   community.mysql.mysql_replication:
#     mode: getprimary
#     login_user: root 
#     login_password: ""
#     login_unix_socket: /var/run/mysqld/mysqld.sock
#   register: primary_info
#   delegate_to: client


- name: Remove old dump file to force re-creation
  ansible.builtin.file:
    path: /tmp/all_databases.sql
    state: absent

  
# - name: Stop Replica
#   community.mysql.mysql_replication:
#     mode: stopreplica
#     login_user: root
#     login_password: ""
#     login_unix_socket: /var/run/mysqld/mysqld.sock

- name: Create replication for user i2 on db1
  community.mysql.mysql_user:
    name: repl_user_2
    password: "repl_2_pw"
    plugin: mysql_native_password
    host: "{{ mysql_server_2_ip }}"
    priv: "*.*:REPLICATION SLAVE"
    state: present
    login_user: root
    login_unix_socket: /var/run/mysqld/mysqld.sock
  notify: 
    - Flush Privileges 
    - Restart MySQL

- name: Lock tables for replication snapshot
  community.mysql.mysql_query:
    login_user: root
    login_unix_socket: /var/run/mysqld/mysqld.sock
    query: >
      FLUSH TABLES WITH READ LOCK;

- name: Show Primary Status 
  community.mysql.mysql_query:
    login_db: "{{mysql_login_db}}"
    login_user: "{{mysql_login_user}}"
    login_password: ""
    login_unix_socket: "{{mysql_socket}}" 
    query: > 
      SHOW MASTER STATUS; 
  register: master_status_primary

- name: Dump database for replication
  ansible.builtin.shell: >
    mysqldump --single-transaction --set-gtid-purged=OFF --master-data=2 -u root --socket=/var/run/mysqld/mysqld.sock --all-databases > /tmp/all_databases.sql
  args:
    creates: /tmp/all_databases.sql

- name: Fetch dump from Primary (m2) to Ansible Controller
  ansible.builtin.fetch:
    src: /tmp/all_databases.sql
    dest: /tmp/all_databases.sql
    flat: yes

- name: Unlock tables after replication snapshot
  community.mysql.mysql_query:
    query: "UNLOCK TABLES;"
    login_user: root
    login_unix_socket: /var/run/mysqld/mysqld.sock

# - name: Change primary to primary server and use binary log
#   community.mysql.mysql_replication:
#     mode: changeprimary
#     primary_host: "{{mysql_server_2_ip}}"
#     primary_log_file: "{{primary_info.File}}"
#     primary_log_pos: "{{primary_info.Position}}" 
#     login_user: root 
#     login_password: ""
#     primary_user: repl_user_1
#     primary_password: "repl_1_pw"
#     login_unix_socket: /var/run/mysqld/mysqld.sock


# - name: Start Replica
#   community.mysql.mysql_replication:
#     mode: startreplica
#     login_user: root
#     login_password: ""
#     login_unix_socket: /var/run/mysqld/mysqld.sock

  
# - name: Fetch [SQL Running & IO Running]
#   community.mysql.mysql_query:
#     login_db: "{{mysql_login_db}}"
#     login_user: "{{mysql_login_user}}"
#     login_password: ""
#     login_unix_socket: "{{mysql_socket}}" 
#     query: > 
#       SHOW REPLICA STATUS; 
#   register: replica_status


# - name: Set facts for replica status
#   set_fact:
#     replica_io_running: "{{ replica_status.query_result[0][0].Replica_IO_Running }}"
#     replica_sql_running: "{{ replica_status.query_result[0][0].Replica_SQL_Running }}"

# - name: Debug IO Running
#   debug:
#     var: replica_io_running

# - name: Debug SQL Running
#   debug:
#     var: replica_sql_running
