- name: Install HAProxy 
  ansible.builtin.apt: 
    name: haproxy 
    state: present 

- name: Erase haproxy.conf |Â Copy conf file [Half is copied from original one]
  ansible.builtin.copy: 
    dest: /etc/haproxy/haproxy.cfg 
    backup: yes
    validate: 'haproxy -c -f %s'
    content: |
      global
                log /dev/log local0
                log /dev/log local1 notice
                log /dev/log local2
                chroot /var/lib/haproxy
                stats socket /run/haproxy/admin.sock mode 660 level admin
                stats timeout 30s
                user haproxy
                group haproxy
                daemon

            defaults
                log     global
                mode    tcp
                option  logasap
                option  dontlognull
                no option log-separate-errors
                option  tcplog
                retries 3
                timeout connect 2s
                timeout client  3600s
                timeout server  3600s
                timeout check   2s

            listen mysql
                bind    0.0.0.0:6033
                mode    tcp
                option mysql-check user haproxy 
                balance roundrobin
                maxconn 1000
                timeout server 3600s
                timeout client 3600s
                default-server port 3306 fall 3 inter 1s rise 2 downinter 1s on-marked-down shutdown-sessions
                server master1 172.28.100.122:3306 check
                server master2 172.28.101.107:3306 check

- name: Uncomment rsyslog.conf UDP module
  ansible.builtin.lineinfile: 
    path: /etc/rsyslog.conf 
    regexp: '^#?module\(load="imudp"\)'
    line: 'module(load="imudp)'
    state: present 

- name: Uncomment rsyslog.conf UDP input 
  ansible.builtin.lineinfile: 
    path: /etc/rsyslog.conf 
    regexp: '#?input\(type="imudp" port="514"\)' 
    line: 'input(type="imudp" port="514")'
    state: present

- name: Add HAProxy log file to rsyslog.conf
  ansible.builtin.lineinfile: 
    path: /etc/rsyslog.conf 
    insertafter: '^input\(type="imudp" port="514"\)'
    line: 'local2.* /var/log/haproxy.log' 
    state: present 
  notify:
    - Restart rsyslog
    - Restart HAProxy

    

- name: Get all services info 
  ansible.builtin.service_facts: 

- name: Print infos
  debug:
    var: ansible_facts.services['haproxy.service']

